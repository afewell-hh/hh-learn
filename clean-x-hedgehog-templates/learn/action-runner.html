<!--
  templateType: page
  isAvailableForNewContent: true
  label: Action Runner (Private)
  description: Private action runner that executes enrollment and progress actions with membership context before redirecting back to the originating page. Issue #245.
-->
{% set _ = set_response_header('Cache-Control', 'no-store, no-cache, must-revalidate, max-age=0') %}
{% set _ = set_response_header('Pragma', 'no-cache') %}
{% set _ = set_response_header('Expires', '0') %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>Processing your request…</title>
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1a4e8a 0%, #2563eb 100%);
        color: #fff;
      }
      .runner-container {
        background: rgba(0, 0, 0, 0.35);
        border-radius: 16px;
        padding: 48px 40px;
        max-width: 540px;
        width: min(540px, calc(100% - 32px));
        text-align: center;
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.45);
      }
      .runner-spinner {
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        border-top: 4px solid #fff;
        width: 48px;
        height: 48px;
        margin: 0 auto 24px;
        animation: runner-spin 1s linear infinite;
      }
      @keyframes runner-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      h1 {
        font-size: 1.75rem;
        margin: 0 0 12px 0;
      }
      p {
        margin: 0;
        font-size: 1rem;
        opacity: 0.9;
      }
      .runner-details {
        margin-top: 24px;
        font-size: 0.95rem;
        line-height: 1.5;
        opacity: 0.95;
      }
      .runner-actions {
        display: none;
        margin-top: 32px;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
      }
      .runner-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 20px;
        border-radius: 999px;
        border: none;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.95rem;
        transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
      }
      .runner-button.primary {
        background: #fff;
        color: #1a4e8a;
      }
      .runner-button.primary:hover {
        transform: translateY(-1px);
        background: #e0ecff;
      }
      .runner-button.secondary {
        background: rgba(255, 255, 255, 0.12);
        color: #f8fafc;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .runner-button.secondary:hover {
        background: rgba(255, 255, 255, 0.22);
      }
      .runner-icon {
        font-size: 2rem;
        margin-bottom: 16px;
      }
      .runner-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        background: rgba(15, 23, 42, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 999px;
        padding: 6px 12px;
        margin-bottom: 16px;
        font-size: 0.8rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }
    </style>
  </head>
  <body>
    {{ standard_header_includes }}
    {% set constants = get_asset_url("/CLEAN x HEDGEHOG/templates/config/constants.json")|request_json %}
    {% set login_url = constants.LOGIN_URL|default('/_hcms/mem/login') if constants else '/_hcms/mem/login' %}
    {% set is_editor_mode = is_in_editor or is_in_page_preview or request.query_dict.hs_preview or request.query_dict.hs_builder %}

    {# Resolve membership identity using request_contact with personalization_token fallback (Issue #276) #}
    {% set runner_email = '' %}
    {% set runner_contact_id = '' %}
    {% if request_contact.is_logged_in %}
      {% set runner_email = request_contact.email|default('', true) %}
      {% set runner_contact_id = request_contact.hs_object_id|default(request_contact.vid, true) %}
    {% endif %}

    {% if not runner_email %}
      {% set runner_email = personalization_token('contact.email', '') %}
    {% endif %}

    {% if not runner_contact_id %}
      {% set runner_contact_id = personalization_token('contact.hs_object_id', '') %}
    {% endif %}

    {% set is_logged_in = request_contact.is_logged_in or runner_email %}

    <div class="runner-container" id="action-runner-container">
      <div id="runner-icon" class="runner-icon">⚙️</div>
      <div class="runner-badge" id="runner-badge">
        Secure Action Runner
      </div>
      <div class="runner-spinner" id="action-runner-spinner"></div>
      <h1 id="action-runner-title">Processing your request…</h1>
      <p id="action-runner-message">Hold tight while we securely complete your action.</p>
      <div class="runner-details" id="action-runner-details"></div>
      <div class="runner-actions" id="action-runner-actions">
        <a href="/learn" class="runner-button primary" id="action-runner-primary">Return to Learn</a>
        <a href="#" class="runner-button secondary" id="action-runner-secondary">Back to previous page</a>
      </div>
    </div>

    <div
      id="hhl-action-runner"
      data-is-editor="{{ 'true' if is_editor_mode else 'false' }}"
      data-is-logged-in="{{ 'true' if is_logged_in else 'false' }}"
      data-email="{{ runner_email|escapejs if runner_email else '' }}"
      data-contact-id="{{ runner_contact_id|escapejs if runner_contact_id else '' }}"
      data-track-url="{{ constants.TRACK_EVENTS_URL if constants else '' }}"
      data-login-url="{{ login_url }}"
      data-actions="{{ {
        'enroll_pathway': {
          'event': 'learning_pathway_enrolled',
          'required': ['slug'],
          'optional': ['source', 'course_slug']
        },
        'enroll_course': {
          'event': 'learning_course_enrolled',
          'required': ['slug'],
          'optional': ['source', 'pathway_slug']
        },
        'record_progress': {
          'event': 'learning_module_progress',
          'required': ['module_slug', 'status'],
          'optional': ['pathway_slug', 'course_slug']
        }
      }|tojson|escapehtml }}"
    ></div>

    {% if is_editor_mode %}
      <script>
        (function(){
          var title = document.getElementById('action-runner-title');
          var message = document.getElementById('action-runner-message');
          var spinner = document.getElementById('action-runner-spinner');
          if (spinner) spinner.style.display = 'none';
          if (title) title.textContent = 'Editor Preview: Action Runner Disabled';
          if (message) {
            message.textContent = 'This private page executes enrollment and progress actions for signed-in learners. Redirect logic is paused while editing so you can update copy or layout safely.';
          }
          var badge = document.getElementById('runner-badge');
          if (badge) badge.textContent = 'Editor Preview';
        })();
      </script>
    {% else %}
      <script defer src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/js/login-helper.js') }}"></script>
      <script defer src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/js/action-runner.js') }}"></script>
    {% endif %}
    {{ standard_footer_includes }}
  </body>
</html>
