<!DOCTYPE html>
<html lang="en">
<!--
  Action Runner
  Purpose: Server-rendered enrollment/progress event handler
  Flow:
    1. Receives URL params (action, slug, redirect_url, etc.)
    2. Builds appropriate event payload for /events/track
    3. POSTs to Lambda API with JWT auth
    4. Saves result to sessionStorage for feedback
    5. Redirects back to original page

  Supported Actions:
    - enroll_pathway: Triggers learning_pathway_enrolled event
    - enroll_course: Triggers learning_course_enrolled event
    - mark_module_started: Triggers learning_module_started event
    - mark_module_completed: Triggers learning_module_completed event

  Related: Issue #245, Issue #276
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processing...</title>

  {# Load constants for API endpoints #}
  {% set constants_url = get_asset_url("/CLEAN x HEDGEHOG/templates/config/constants.json") %}
  {% set constants = constants_url|request_json %}

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container {
      text-align: center;
      padding: 2rem;
      max-width: 500px;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    h1 {
      font-size: 1.5rem;
      margin: 0 0 0.5rem;
      font-weight: 600;
    }
    p {
      opacity: 0.9;
      margin: 0;
    }
    .error {
      background: #ff4444;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner"></div>
    <h1 id="status">Processing enrollment...</h1>
    <p id="message">Please wait a moment</p>
    <div id="error" class="error"></div>
  </div>

  <script>
    (function() {
      'use strict';

      var debug = localStorage.getItem('HHL_DEBUG') === 'true';

      // Constants from HubL
      var constants = {{ constants|tojson }};
      var trackUrl = constants.TRACK_EVENTS_URL || 'https://hvoog2lnha.execute-api.us-west-2.amazonaws.com/events/track';
      var enableCrm = constants.ENABLE_CRM_PROGRESS || false;

      // Parse URL parameters
      var params = new URLSearchParams(window.location.search);
      var action = params.get('action');
      var slug = params.get('slug');
      var redirectUrl = params.get('redirect_url') || '/learn';
      var pathwaySlug = params.get('pathway_slug');
      var courseSlug = params.get('course_slug');
      var moduleSlug = params.get('module_slug');
      var enrollmentSource = params.get('source') || 'action_runner';

      if (debug) {
        console.log('[action-runner] Params:', {
          action: action,
          slug: slug,
          pathwaySlug: pathwaySlug,
          courseSlug: courseSlug,
          moduleSlug: moduleSlug,
          source: enrollmentSource,
          redirectUrl: redirectUrl
        });
      }

      /**
       * Build event payload based on action type
       */
      function buildEventPayload(action) {
        var timestamp = new Date().toISOString();
        var eventName = null;
        var payload = { ts: timestamp };

        if (action === 'enroll_pathway') {
          eventName = 'learning_pathway_enrolled';
          payload.pathway_slug = slug || pathwaySlug;
          payload.enrollment_source = enrollmentSource;
        } else if (action === 'enroll_course') {
          eventName = 'learning_course_enrolled';
          payload.course_slug = slug || courseSlug;
          if (pathwaySlug) {
            payload.pathway_slug = pathwaySlug;
          }
          payload.enrollment_source = enrollmentSource;
        } else if (action === 'mark_module_started' || action === 'mark_started') {
          eventName = 'learning_module_started';
          payload.module_slug = slug || moduleSlug;
          if (courseSlug) payload.course_slug = courseSlug;
          if (pathwaySlug) payload.pathway_slug = pathwaySlug;
        } else if (action === 'mark_module_completed' || action === 'mark_completed') {
          eventName = 'learning_module_completed';
          payload.module_slug = slug || moduleSlug;
          if (courseSlug) payload.course_slug = courseSlug;
          if (pathwaySlug) payload.pathway_slug = pathwaySlug;
        }

        if (!eventName) {
          throw new Error('Unsupported action: ' + action);
        }

        // Build final event object
        var event = {
          eventName: eventName,
          payload: payload
        };

        // Add top-level fields for enrollment events (required by validation schema)
        if (eventName === 'learning_pathway_enrolled') {
          event.pathway_slug = payload.pathway_slug;
          event.enrollment_source = enrollmentSource;
        } else if (eventName === 'learning_course_enrolled') {
          event.course_slug = payload.course_slug;
          if (pathwaySlug) {
            event.pathway_slug = pathwaySlug;
          }
          event.enrollment_source = enrollmentSource;
        }

        return event;
      }

      /**
       * Get JWT token from localStorage
       */
      function getAuthToken() {
        try {
          return localStorage.getItem('hhl_auth_token');
        } catch (e) {
          if (debug) console.warn('[action-runner] Cannot access localStorage:', e);
          return null;
        }
      }

      /**
       * Build fetch headers with JWT if available
       */
      function buildHeaders() {
        var headers = { 'Content-Type': 'application/json' };
        var token = getAuthToken();
        if (token) {
          headers['Authorization'] = 'Bearer ' + token;
        }
        return headers;
      }

      /**
       * Save result to sessionStorage for feedback on redirect
       */
      function saveResult(status, action, params) {
        try {
          var result = {
            status: status,
            action: action,
            params: params,
            timestamp: new Date().toISOString()
          };
          sessionStorage.setItem('hhl_last_action', JSON.stringify(result));
          if (debug) console.log('[action-runner] Saved result:', result);
        } catch (e) {
          if (debug) console.warn('[action-runner] Cannot save result:', e);
        }
      }

      /**
       * Show error and allow retry
       */
      function showError(message) {
        document.getElementById('status').textContent = 'Enrollment Failed';
        document.getElementById('message').textContent = 'We encountered an error';
        var errorEl = document.getElementById('error');
        errorEl.textContent = message;
        errorEl.style.display = 'block';

        // Redirect after 5 seconds
        setTimeout(function() {
          window.location.href = redirectUrl;
        }, 5000);
      }

      /**
       * Main execution
       */
      function run() {
        // Validate required params
        if (!action) {
          showError('Missing action parameter');
          saveResult('error', null, { error: 'missing_action' });
          return;
        }

        if (!slug && !pathwaySlug && !courseSlug && !moduleSlug) {
          showError('Missing slug parameter');
          saveResult('error', action, { error: 'missing_slug' });
          return;
        }

        try {
          var eventPayload = buildEventPayload(action);

          if (debug) {
            console.log('[action-runner] Event payload:', eventPayload);
          }

          // Update UI
          document.getElementById('status').textContent = 'Saving progress...';

          // POST to /events/track
          fetch(trackUrl, {
            method: 'POST',
            headers: buildHeaders(),
            body: JSON.stringify(eventPayload),
            credentials: 'omit'
          })
            .then(function(response) {
              if (!response.ok) {
                return response.json().then(function(error) {
                  throw new Error(error.error || 'HTTP ' + response.status);
                });
              }
              return response.json();
            })
            .then(function(data) {
              if (debug) console.log('[action-runner] Success:', data);

              // Save success result
              saveResult('success', action, {
                slug: slug,
                pathway_slug: pathwaySlug,
                course_slug: courseSlug,
                module_slug: moduleSlug
              });

              // Update UI
              document.getElementById('status').textContent = 'Success!';
              document.getElementById('message').textContent = 'Redirecting...';

              // Redirect back
              setTimeout(function() {
                window.location.href = redirectUrl;
              }, 500);
            })
            .catch(function(error) {
              console.error('[action-runner] Failed to track event:', error);

              // Save error result (but still redirect)
              saveResult('error', action, {
                slug: slug,
                error: error.message || String(error)
              });

              showError(error.message || 'Network error');
            });

        } catch (error) {
          console.error('[action-runner] Error building payload:', error);
          saveResult('error', action, { error: error.message });
          showError(error.message || 'Invalid request');
        }
      }

      // Execute when page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run);
      } else {
        run();
      }
    })();
  </script>
</body>
</html>
