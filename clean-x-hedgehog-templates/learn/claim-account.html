<!--
  templateType: "page"
  isAvailableForNewContent: true
-->
{% extends "/CLEAN x HEDGEHOG/templates/layouts/base.html" %}

{% block head %}
  {{ super() }}

  {% set constants = {
    'DEFAULT_SOCIAL_IMAGE_URL': 'https://hedgehog.cloud/hubfs/social-share-default.png',
    'AUTH_LOGIN_URL': 'https://api.hedgehog.cloud/auth/login',
    'AUTH_SIGNUP_URL': 'https://api.hedgehog.cloud/auth/signup',
    'AUTH_CHECK_EMAIL_URL': 'https://api.hedgehog.cloud/auth/check-email',
    'AUTH_CLAIM_URL': 'https://api.hedgehog.cloud/auth/claim'
  } %}
  {% set social_image = constants.DEFAULT_SOCIAL_IMAGE_URL %}

  <title>Claim Your Hedgehog Learn Account</title>
  <meta name="description" content="Already in our CRM but no password yet? Claim your Hedgehog Learn account and set your credentials.">
  <link rel="canonical" href="https://{{ request.domain }}/learn/claim-account">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Claim Your Hedgehog Learn Account">
  <meta property="og:description" content="Set your password and activate your Hedgehog Learn account.">
  <meta property="og:url" content="https://{{ request.domain }}/learn/claim-account">
  <meta property="og:image" content="{{ social_image }}">
{% endblock head %}

{% block body %}
  <main id="main-content">
    <section class="registration-hero">
      <div class="registration-hero-content">
        <h1 class="registration-title">Claim your account</h1>
        <p class="registration-subtitle">If you are already in our CRM, we can send you an account invite to set your password.</p>
      </div>
    </section>

    <section class="registration-section">
      <div class="registration-container">
        <div class="registration-layout">
          <aside class="registration-benefits">
            <h2>How it works</h2>
            <ul class="benefits-list">
              <li>
                <div class="benefit-content">
                  <h3>1. Enter your email</h3>
                  <p>We check whether your email already exists in Cognito and HubSpot CRM.</p>
                </div>
              </li>
              <li>
                <div class="benefit-content">
                  <h3>2. Get the right path</h3>
                  <p>We route you to sign in, claim your account, or complete sign-up.</p>
                </div>
              </li>
              <li>
                <div class="benefit-content">
                  <h3>3. Continue learning</h3>
                  <p>After authentication, you return to your original Learn page automatically.</p>
                </div>
              </li>
            </ul>
          </aside>

          <div class="registration-form-container">
            <h2>Claim account access</h2>
            <p>Enter the email address associated with your Hedgehog activity.</p>

            <form id="claim-account-form" novalidate>
              <label for="claim-email">Work email</label>
              <input id="claim-email" name="email" type="email" required autocomplete="email" placeholder="you@company.com">
              <button id="claim-submit" type="submit">Continue</button>
            </form>

            <div id="claim-status" aria-live="polite" style="margin-top:1rem;"></div>

            <div class="registration-footer">
              {% set login_url = constants.AUTH_LOGIN_URL %}
              {% set register_url = constants.AUTH_SIGNUP_URL %}
              <p>Already have a password? <a href="{{ login_url }}?redirect_url=/learn">Sign in</a></p>
              <p>Need a brand new account? <a href="{{ register_url }}?redirect_url=/learn">Sign up</a></p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    (function() {
      var form = document.getElementById('claim-account-form');
      var emailInput = document.getElementById('claim-email');
      var statusNode = document.getElementById('claim-status');
      var submitButton = document.getElementById('claim-submit');

      var config = {
        checkEmailUrl: '{{ constants.AUTH_CHECK_EMAIL_URL }}',
        claimUrl: '{{ constants.AUTH_CLAIM_URL }}',
        loginUrl: '{{ constants.AUTH_LOGIN_URL }}',
        signupUrl: '{{ constants.AUTH_SIGNUP_URL }}'
      };

      function getRedirectUrl() {
        var params = new URLSearchParams(window.location.search || '');
        var raw = params.get('redirect_url') || '/learn';
        if (!raw || raw.indexOf('://') !== -1 || raw.indexOf('//') === 0 || raw.indexOf('javascript:') === 0) {
          return '/learn';
        }
        return raw.charAt(0) === '/' ? raw : '/' + raw;
      }

      function setStatus(message) {
        statusNode.textContent = message;
      }

      async function checkEmail(email) {
        var response = await fetch(config.checkEmailUrl + '?email=' + encodeURIComponent(email), {
          method: 'GET',
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        if (!response.ok) {
          throw new Error('Could not verify email');
        }
        return response.json();
      }

      async function claimEmail(email) {
        var response = await fetch(config.claimUrl, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ email: email })
        });
        var payload = {};
        try { payload = await response.json(); } catch (err) {}
        if (!response.ok && payload.error !== 'no_crm_contact') {
          throw new Error('Unable to claim account');
        }
        return payload;
      }

      form.addEventListener('submit', async function(event) {
        event.preventDefault();
        var email = (emailInput.value || '').trim().toLowerCase();
        if (!email) {
          setStatus('Enter a valid email address.');
          return;
        }

        submitButton.disabled = true;
        setStatus('Checking your account status...');

        try {
          var redirectUrl = getRedirectUrl();
          var result = await checkEmail(email);

          if (result.exists_in_cognito) {
            setStatus('Account found. Redirecting to sign in...');
            window.location.href = config.loginUrl + '?redirect_url=' + encodeURIComponent(redirectUrl);
            return;
          }

          if (result.exists_in_hubspot) {
            setStatus('Found in CRM. Sending your invite email...');
            var claimResult = await claimEmail(email);
            if (claimResult.status === 'invite_sent') {
              setStatus('Invite sent. Check your email for the account setup link, then sign in.');
              return;
            }
            if (claimResult.status === 'already_exists') {
              window.location.href = config.loginUrl + '?redirect_url=' + encodeURIComponent(redirectUrl);
              return;
            }
          }

          setStatus('No existing account found. Redirecting to sign-up...');
          window.location.href = config.signupUrl + '?redirect_url=' + encodeURIComponent(redirectUrl);
        } catch (error) {
          setStatus('We could not process your request right now. Please try again.');
        } finally {
          submitButton.disabled = false;
        }
      });
    })();
  </script>
{% endblock body %}
