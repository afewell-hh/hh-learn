<!--
  templateType: "page"
  isAvailableForNewContent: true
-->
{% extends "/CLEAN x HEDGEHOG/templates/layouts/base.html" %}
{% from "/CLEAN x HEDGEHOG/templates/learn/macros/left-nav.html" import learning_left_nav %}

{% block head %}
  {{ super() }}

  {# Left nav CSS and JS for list pages #}
  <link rel="stylesheet" href="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/css/left-nav.css') }}">
  <link rel="stylesheet" href="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/css/module-media.css') }}">
  <script src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/js/left-nav.js') }}" defer></script>

  {#
    Issue #327 Fix: Inline constants instead of using request_json (which doesn't exist in HubL)
    HubL cannot fetch/parse JSON files server-side, so we inline the values directly.
    Defined in shared scope so both detail and list views can access.
    Source: clean-x-hedgehog-templates/config/constants.json
  #}
  {% set constants = {
    'HUBDB_MODULES_TABLE_ID': '135621904',
    'HUBDB_PATHWAYS_TABLE_ID': '135381504',
    'HUBDB_COURSES_TABLE_ID': '135381433',
    'HUBDB_CATALOG_TABLE_ID': '136199186',
    'DEFAULT_SOCIAL_IMAGE_URL': 'https://hedgehog.cloud/hubfs/social-share-default.png',
    'ENABLE_CRM_PROGRESS': true,
    'LOGOUT_URL': '/_hcms/mem/logout',
    'LOGIN_URL': '/_hcms/mem/login',
    'AUTH_LOGIN_URL': 'https://api.hedgehog.cloud/auth/login',
    'AUTH_ME_URL': 'https://api.hedgehog.cloud/auth/me',
    'AUTH_LOGOUT_URL': 'https://api.hedgehog.cloud/auth/logout',
    'TRACK_EVENTS_ENABLED': true,
    'TRACK_EVENTS_URL': 'https://api.hedgehog.cloud/events/track',
    'ACTION_RUNNER_URL': '/learn/action-runner'
  } %}

  {% if dynamic_page_hubdb_row %}
    {# SEO metadata for detail pages #}
    {% set page_title = dynamic_page_hubdb_row.hs_name ~ " - Learn Hedgehog" %}
    {% set meta_desc = dynamic_page_hubdb_row.meta_description|striptags|truncate(160) if dynamic_page_hubdb_row.meta_description else "Learn " ~ dynamic_page_hubdb_row.hs_name %}
    {% set canonical_url = "https://" ~ request.domain ~ "/learn/modules/" ~ dynamic_page_hubdb_row.hs_path %}
    {% set social_image = dynamic_page_hubdb_row.social_image_url if dynamic_page_hubdb_row.social_image_url else constants.DEFAULT_SOCIAL_IMAGE_URL %}

    <title>{{ page_title }}</title>
    <meta name="description" content="{{ meta_desc }}">
    <link rel="canonical" href="{{ canonical_url }}">

    {# Open Graph tags #}
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ page_title }}">
    <meta property="og:description" content="{{ meta_desc }}">
    <meta property="og:url" content="{{ canonical_url }}">
    <meta property="og:image" content="{{ social_image }}">

    {# Twitter Card tags #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ page_title }}">
    <meta name="twitter:description" content="{{ meta_desc }}">
    <meta name="twitter:image" content="{{ social_image }}">
    {# HHL pageview meta for JS beacon #}
    <meta name="hhl:module_slug" content="{{ dynamic_page_hubdb_row.hs_path }}">
  {% else %}
    {# SEO metadata for list pages #}
    {% set social_image = constants.DEFAULT_SOCIAL_IMAGE_URL %}

    <title>Learning Modules - Learn Hedgehog</title>
    <meta name="description" content="Browse all learning modules. Build high-performance AI networks on open Ethernet and OCP hardware with hands-on learning content.">
    <link rel="canonical" href="https://{{ request.domain }}/learn/modules">

    {# Open Graph tags #}
    <meta property="og:type" content="website">
    <meta property="og:title" content="Learning Modules - Learn Hedgehog">
    <meta property="og:description" content="Browse all learning modules. Build high-performance AI networks on open Ethernet and OCP hardware with hands-on learning content.">
    <meta property="og:url" content="https://{{ request.domain }}/learn/modules">
    <meta property="og:image" content="{{ social_image }}">

    {# Twitter Card tags #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Learning Modules - Learn Hedgehog">
    <meta name="twitter:description" content="Browse all learning modules. Build high-performance AI networks on open Ethernet and OCP hardware with hands-on learning content.">
    <meta name="twitter:image" content="{{ social_image }}">
  {% endif %}

  {% if dynamic_page_hubdb_row %}
    {# Compute prev/next early for head tags - using same logic as navigation #}
    {% set head_prev_module = none %}
    {% set head_next_module = none %}
    {% set head_current_slug = dynamic_page_hubdb_row.hs_path %}
    {#
      Issue #327 Fix: Inline constants instead of using request_json (which doesn't exist in HubL)
      HubL cannot fetch/parse JSON files server-side, so we inline the values directly.
      Source: clean-x-hedgehog-templates/config/constants.json
    #}
    
    {% set head_pathways_table_id = head_constants.HUBDB_PATHWAYS_TABLE_ID if head_constants else none %}
    {% set head_modules_table_id = head_constants.HUBDB_MODULES_TABLE_ID if head_constants else dynamic_page_hubdb_table_id %}
    {% set head_in_pathway = false %}

    {% if head_pathways_table_id %}
      {% set head_all_pathways = hubdb_table_rows(head_pathways_table_id, "tags__not__icontains=archived") %}
      {% for pathway in head_all_pathways %}
        {% if pathway.module_slugs_json and not head_in_pathway %}
          {% set head_module_slugs = pathway.module_slugs_json|fromjson %}
          {% if head_module_slugs and head_current_slug in head_module_slugs %}
            {% set head_in_pathway = true %}
            {% for slug in head_module_slugs %}
              {% if slug == head_current_slug %}
                {% set head_current_index = loop.index0 %}
                {% if head_current_index > 0 %}
                  {% set head_prev_slug = head_module_slugs[head_current_index - 1] %}
                  {% set head_prev_rows = hubdb_table_rows(head_modules_table_id, "path__eq=" ~ head_prev_slug ~ "&tags__not__icontains=archived") %}
                  {% if head_prev_rows and head_prev_rows|length > 0 %}
                    {% set head_prev_module = head_prev_rows[0] %}
                  {% endif %}
                {% endif %}
                {% if head_current_index < (head_module_slugs|length - 1) %}
                  {% set head_next_slug = head_module_slugs[head_current_index + 1] %}
                  {% set head_next_rows = hubdb_table_rows(head_modules_table_id, "path__eq=" ~ head_next_slug ~ "&tags__not__icontains=archived") %}
                  {% if head_next_rows and head_next_rows|length > 0 %}
                    {% set head_next_module = head_next_rows[0] %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if not head_in_pathway and head_modules_table_id %}
      {% set head_all_modules = hubdb_table_rows(head_modules_table_id, "orderBy=display_order&tags__not__icontains=archived") %}
      {% for module in head_all_modules %}
        {% if module.hs_path == head_current_slug %}
          {% set head_current_index = loop.index0 %}
          {% if head_current_index > 0 %}
            {% set head_prev_module = head_all_modules[head_current_index - 1] %}
          {% endif %}
          {% if head_current_index < (head_all_modules|length - 1) %}
            {% set head_next_module = head_all_modules[head_current_index + 1] %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {# Add SEO/browser hint rel links #}
    {% if head_prev_module %}
  <link rel="prev" href="/learn/modules/{{ head_prev_module.hs_path }}">
    {% endif %}
    {% if head_next_module %}
  <link rel="next" href="/learn/modules/{{ head_next_module.hs_path }}">
    {% endif %}

    {# JSON-LD structured data for detail pages #}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "LearningResource",
      "name": {{ dynamic_page_hubdb_row.hs_name|tojson }},
      {% if dynamic_page_hubdb_row.meta_description %}
      "description": {{ dynamic_page_hubdb_row.meta_description|striptags|tojson }},
      {% endif %}
      "url": "https://{{ request.domain }}/learn/modules/{{ dynamic_page_hubdb_row.hs_path }}",
      {% if dynamic_page_hubdb_row.estimated_minutes %}
      "timeRequired": "PT{{ dynamic_page_hubdb_row.estimated_minutes }}M",
      {% endif %}
      {% if dynamic_page_hubdb_row.difficulty %}
      "educationalLevel": {{ dynamic_page_hubdb_row.difficulty.label|tojson }},
      {% endif %}
      {% if dynamic_page_hubdb_row.tags %}
      "about": [
        {% set tag_list = dynamic_page_hubdb_row.tags.split(',') %}
        {% for tag in tag_list %}
          {% if tag|trim|lower != 'archived' %}
        { "@type": "Thing", "name": {{ tag|trim|tojson }} }{% if not loop.last %},{% endif %}
          {% endif %}
        {% endfor %}
      ],
      {% endif %}
      "learningResourceType": "Module",
      "inLanguage": "en-US"
    }
    </script>

    {# BreadcrumbList JSON-LD #}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Learn",
          "item": "https://{{ request.domain }}/learn"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": {{ dynamic_page_hubdb_row.hs_name|tojson }}
        }
      ]
    }
    </script>
  {% else %}
    {# JSON-LD structured data for list page #}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "ItemList",
      "name": "Learning Modules",
      "description": "Hedgehog AI Networking learning modules",
      "itemListElement": [
        {% if dynamic_page_hubdb_table_id %}
          {% set modules = hubdb_table_rows(dynamic_page_hubdb_table_id, "orderBy=display_order&tags__not__icontains=archived") %}
          {% for module in modules %}
        {
          "@type": "ListItem",
          "position": {{ loop.index }},
          "item": {
            "@type": "LearningResource",
            "name": {{ module.hs_name|tojson }},
            "url": "https://{{ request.domain }}/learn/modules/{{ module.hs_path }}"
            {% if module.meta_description %}
            ,"description": {{ module.meta_description|striptags|tojson }}
            {% endif %}
          }
        }{% if not loop.last %},{% endif %}
          {% endfor %}
        {% endif %}
      ]
    }
    </script>
  {% endif %}
{% endblock head %}

{% block body %}
<style>
  /* Header section styling */
  .learn-header-section {
    width: 100vw;
    background: #1a4e8a url('https://hedgehog.cloud/hubfs/hh-clouds.webp') center center/cover no-repeat;
    color: #fff;
    padding: 96px 0 64px 0;
    margin-left: calc(-50vw + 50%);
    margin-right: calc(-50vw + 50%);
  }
  .learn-header-content {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 24px;
    text-align: center;
  }
  .learn-page-title {
    font-size: 2.8rem;
    font-weight: 700;
    margin: 0;
    letter-spacing: -1px;
  }
  .learn-page-subtitle {
    font-size: 1.2rem;
    font-weight: 400;
    margin: 0;
    opacity: 0.9;
  }
  .learn-header-nav {
    display: flex;
    gap: 24px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .learn-header-nav a {
    color: #fff;
    text-decoration: none;
    font-size: 0.9375rem;
    font-weight: 500;
    padding: 8px 16px;
    border-radius: 6px;
    transition: background 0.2s;
  }
  .learn-header-nav a:hover {
    background: rgba(255, 255, 255, 0.15);
  }
  .auth-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
  }
  .user-greeting {
    color: #fff;
    font-size: 0.875rem;
    opacity: 0.9;
  }
  .auth-link {
    color: #fff;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 6px 16px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    transition: all 0.2s;
  }
  .auth-link:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.5);
  }

  /* Main content section */
  .learn-main-section {
    display: flex;
    justify-content: center;
    width: 100%;
    margin-top: 0;
    min-height: 60vh;
  }
  .learn-container {
    max-width: 1600px;
    width: 100%;
    background: #fff;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 2px 24px rgba(26,78,138,0.06);
    min-height: 60vh;
  }

  /* Module grid (list view) */
  .modules-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
    margin-top: 32px;
  }
  .module-card {
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    padding: 24px;
    transition: box-shadow 0.2s, transform 0.2s;
    cursor: pointer;
    text-decoration: none;
    display: block;
  }
  .module-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  .module-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  .difficulty-badge {
    background: #EFF6FF;
    color: #0066CC;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
  }
  .module-time {
    color: #666;
    font-size: 0.875rem;
  }
  .module-card h3 {
    margin: 0 0 12px 0;
    font-size: 1.25rem;
    color: #1a4e8a;
  }
  .module-card p {
    color: #666;
    margin: 0 0 16px 0;
    line-height: 1.6;
  }
  .module-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
  }
  .module-tag {
    background: #F3F4F6;
    color: #374151;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
  }
  .module-cta {
    color: #0066CC;
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
  }

  /* Module detail view */
  .module-detail {
    max-width: 900px;
    margin: 0 auto;
  }
  .module-breadcrumbs {
    padding: 16px 0;
    color: #666;
    font-size: 0.875rem;
  }
  .module-breadcrumbs a {
    color: #0066CC;
    text-decoration: none;
  }
  .module-detail-header {
    margin: 32px 0;
    padding-bottom: 24px;
    border-bottom: 1px solid #E5E7EB;
  }
  .module-detail-header h1 {
    margin: 0 0 16px 0;
    color: #1a4e8a;
  }
  .module-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
  }
  .module-content {
    line-height: 1.8;
    font-size: 1.0625rem;
  }
  .module-content h2 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.75rem;
    color: #111827;
  }
  .module-content h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-size: 1.375rem;
    color: #111827;
  }
  .module-content code {
    background: #F3F4F6;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.875em;
    color: #E83E8C;
  }
  .module-content pre {
    background: #1E293B;
    color: #F1F5F9;
    padding: 16px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 16px 0;
  }
  .module-content pre code {
    background: none;
    padding: 0;
    color: inherit;
  }

  /* Hide a duplicate leading H1 inside rendered module content */
  .module-content > h1:first-child {
    display: none;
  }

  /* Prerequisites section */
  .module-prerequisites {
    margin: 24px 0;
    padding: 20px;
    background: #F9FAFB;
    border-left: 4px solid #1a4e8a;
    border-radius: 8px;
  }
  .module-prerequisites h2 {
    margin: 0 0 12px 0;
    font-size: 1.25rem;
    color: #1a4e8a;
  }
  .module-prerequisites ul {
    margin: 0;
    padding-left: 24px;
    list-style-type: disc;
  }
  .module-prerequisites li {
    margin: 8px 0;
    line-height: 1.6;
  }
  .module-prerequisites a {
    color: #0066CC;
    text-decoration: none;
    font-weight: 500;
  }
  .module-prerequisites a:hover {
    text-decoration: underline;
  }

  /* Prev/Next Navigation */
  .module-nav {
    margin: 24px 0;
    padding: 20px 0;
    border-top: 1px solid #E5E7EB;
    border-bottom: 1px solid #E5E7EB;
  }
  .module-nav-container {
    display: flex;
    justify-content: space-between;
    align-items: stretch;
    gap: 16px;
  }
  .module-nav-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s;
    background: #F9FAFB;
    flex: 1;
    max-width: 48%;
  }
  .module-nav-link:hover {
    background: #EFF6FF;
    border-color: #1a4e8a;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(26,78,138,0.15);
  }
  .module-nav-link:focus {
    outline: 2px solid #1a4e8a;
    outline-offset: 2px;
  }
  .module-nav-prev {
    justify-content: flex-start;
  }
  .module-nav-next {
    justify-content: flex-end;
    margin-left: auto;
  }
  .module-nav-arrow {
    font-size: 1.5rem;
    color: #1a4e8a;
    font-weight: 700;
    flex-shrink: 0;
  }
  .module-nav-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
  }
  .module-nav-next .module-nav-content {
    align-items: flex-end;
    text-align: right;
  }
  .module-nav-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #666;
    font-weight: 600;
  }
  .module-nav-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #1a4e8a;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .module-nav-spacer {
    flex: 1;
    max-width: 48%;
  }

  /* Pathways band */
  .pathways-band {
    max-width: 1600px;
    margin: 32px auto;
    padding: 0 40px;
  }
  .pathways-band-content {
    background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
    border: 1px solid #BFDBFE;
    border-radius: 12px;
    padding: 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 24px;
  }
  .pathways-band-text {
    flex: 1;
  }
  .pathways-band-text h2 {
    margin: 0 0 8px 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1a4e8a;
  }
  .pathways-band-text p {
    margin: 0;
    font-size: 1rem;
    color: #374151;
  }
  .pathways-band-cta {
    flex-shrink: 0;
  }
  .pathways-cta-button {
    display: inline-block;
    background: #1a4e8a;
    color: #fff;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: background 0.2s, transform 0.2s;
  }
  .pathways-cta-button:hover {
    background: #154171;
    transform: translateY(-2px);
  }

  @media (max-width: 900px) {
    .learn-header-content, .learn-container {
      padding: 0 16px;
    }
    .modules-grid {
      grid-template-columns: 1fr;
    }
    .pathways-band {
      padding: 0 16px;
    }
    .pathways-band-content {
      flex-direction: column;
      align-items: flex-start;
      padding: 24px;
    }
    .pathways-band-cta {
      width: 100%;
    }
    .pathways-cta-button {
      display: block;
      text-align: center;
      width: 100%;
    }
    /* Mobile prev/next navigation */
    .module-nav-container {
      flex-direction: column;
      gap: 12px;
    }
    .module-nav-link {
      max-width: 100%;
    }
    .module-nav-title {
      white-space: normal;
      line-height: 1.4;
    }
  }
</style>

<main id="main-content">
  {% if dynamic_page_hubdb_row %}
    {# Detail view - showing a single module #}
    <section class="learn-header-section">
      <div class="learn-header-content">
        {# Omit a visible H1 in the hero on detail pages to avoid duplicates #}
      </div>
    </section>

    <section class="learn-main-section">
      <div class="learn-container">
        <div class="module-detail">
          <!-- Breadcrumbs -->
          <nav class="module-breadcrumbs" id="hhl-breadcrumbs">
            <a href="/learn">← Back to Learning Portal</a>
            <span id="hhl-course-position" style="display:none; margin-left:12px; color:#666; font-size:0.875rem;"></span>
          </nav>

          <!-- Module Header -->
          <header class="module-detail-header">
            <h1>{{ dynamic_page_hubdb_row.hs_name }}</h1>
            <div class="module-meta">
              <span class="difficulty-badge">
                {{ dynamic_page_hubdb_row.difficulty.label }}
              </span>
              <span class="module-time">
                {{ dynamic_page_hubdb_row.estimated_minutes }} minutes
              </span>
              {% if dynamic_page_hubdb_row.tags %}
                <div class="module-tags">
                  {% set tag_list = dynamic_page_hubdb_row.tags.split(',') %}
                  {% for tag in tag_list %}
                    <span class="module-tag">{{ tag|trim }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            {# Auth context for JS (Issue #345 - Cognito auth with inlined constants) #}
            {#
              Issue #327 Fix: Inline constants instead of using request_json (which doesn't exist in HubL)
              HubL cannot fetch/parse JSON files server-side, so we inline the values directly.
              Source: clean-x-hedgehog-templates/config/constants.json
            #}
            {% set auth_me_url = constants.AUTH_ME_URL if constants and constants.AUTH_ME_URL else 'https://api.hedgehog.cloud/auth/me' %}
            {% set auth_login_url = constants.AUTH_LOGIN_URL if constants and constants.AUTH_LOGIN_URL else 'https://api.hedgehog.cloud/auth/login' %}
            {% set auth_logout_url = constants.AUTH_LOGOUT_URL if constants and constants.AUTH_LOGOUT_URL else 'https://api.hedgehog.cloud/auth/logout' %}
            <div id="hhl-auth-context"
                 data-auth-me-url="{{ auth_me_url }}"
                 data-auth-login-url="{{ auth_login_url }}"
                 data-auth-logout-url="{{ auth_logout_url }}"
                 data-enable-crm="true"
                 data-track-events-url="https://api.hedgehog.cloud/events/track"
                 style="display:none"></div>
            <script src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/learn/assets/js/cognito-auth-integration.js') }}"></script>

            <div class="module-progress-cta" role="region" aria-label="Module progress" style="margin-top:16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
              <button type="button" class="pathways-cta-button" id="hhl-mark-started" aria-label="Mark module as started" style="padding:8px 14px;">
                Mark as started
              </button>
              <button type="button" class="pathways-cta-button" id="hhl-mark-complete" aria-label="Mark module as complete" style="padding:8px 14px;">
                Mark complete
              </button>
              <a id="hhl-back-to-pathway" href="#" style="display:none; color:#0066CC; text-decoration:none; font-weight:600;">← Back to pathway</a>
            </div>
            {# Load external JS to avoid inline script CSP issues #}
            <script src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/js/toast.js') }}"></script>
            <script src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/js/course-context.js') }}"></script>
            <script defer src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/js/login-helper.js') }}"></script>
            {# Line 737 - auth-context.js REMOVED (Issue #345: Cognito-only auth) #}
            <script defer src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/js/course-breadcrumbs.js') }}"></script>
            <script defer src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/js/course-navigation.js') }}"></script>
            <script defer src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/js/progress.js') }}"></script>
            <script defer src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/assets/js/pageview.js') }}"></script>
          </header>

          {% set module_media = [] %}
          {% set raw_media = dynamic_page_hubdb_row.media_json %}
          {% if raw_media %}
            {% if raw_media is string %}
              {% set parsed_media = raw_media|fromjson %}
            {% else %}
              {% set parsed_media = raw_media %}
            {% endif %}
            {% if parsed_media %}
              {% if parsed_media.items is defined %}
                {% set module_media = parsed_media.items %}
              {% else %}
                {% set module_media = parsed_media %}
              {% endif %}
            {% endif %}
          {% endif %}

          {% if module_media and module_media|length > 0 %}
            <section class="module-media-gallery" aria-label="Module media">
              <div class="module-media-grid">
                {% for item in module_media %}
                  {% if item.type == 'image' %}
                    <figure class="module-media-card">
                      <img src="{{ item.url }}" alt="{{ item.alt }}" loading="lazy">
                      {% if item.caption or item.credit %}
                        <figcaption>
                          {% if item.caption %}<span class="module-media-caption">{{ item.caption }}</span>{% endif %}
                          {% if item.credit %}<span class="module-media-credit">{{ item.credit }}</span>{% endif %}
                        </figcaption>
                      {% endif %}
                    </figure>
                  {% elif item.type == 'video' %}
                    <figure class="module-media-card module-media-card--video">
                      <video controls preload="metadata" {% if item.thumbnail_url %}poster="{{ item.thumbnail_url }}"{% endif %} aria-label="{{ item.alt }}">
                        <source src="{{ item.url }}">
                        Your browser does not support the video tag. <a href="{{ item.url }}" target="_blank" rel="noopener">Download the video</a>.
                      </video>
                      {% if item.caption or item.credit %}
                        <figcaption>
                          {% if item.caption %}<span class="module-media-caption">{{ item.caption }}</span>{% endif %}
                          {% if item.credit %}<span class="module-media-credit">{{ item.credit }}</span>{% endif %}
                        </figcaption>
                      {% endif %}
                    </figure>
                  {% endif %}
                {% endfor %}
              </div>
            </section>
          {% endif %}

          {# Prerequisites Section #}
          {% if dynamic_page_hubdb_row.prerequisites_json %}
            {% set prerequisites = dynamic_page_hubdb_row.prerequisites_json|fromjson %}

            {% if prerequisites and prerequisites|length > 0 %}
              <section class="module-prerequisites" id="prerequisites" role="region" aria-label="Prerequisites">
                <h2>Prerequisites</h2>
                <ul>
                  {% for prereq in prerequisites %}
                    {% if prereq is string %}
                      {# Internal module slug - resolve to link #}
                      {% set prereq_slug = prereq %}
                      {% set modules_table_id = constants.HUBDB_MODULES_TABLE_ID or dynamic_page_hubdb_table_id %}
                      {% if modules_table_id %}
                        {% set prereq_rows = hubdb_table_rows(modules_table_id, "path__eq=" ~ prereq_slug ~ "&tags__not__icontains=archived") %}
                        {% if prereq_rows and prereq_rows|length > 0 %}
                          <li><a href="/learn/{{ prereq_rows[0].hs_path }}">{{ prereq_rows[0].hs_name }}</a></li>
                        {% else %}
                          {# Module not found - render as plain text with warning comment #}
                          <li>{{ prereq_slug }}<!-- Warning: prerequisite module "{{ prereq_slug }}" not found in HubDB --></li>
                        {% endif %}
                      {% else %}
                        {# No table ID available - render as plain text #}
                        <li>{{ prereq_slug }}<!-- Warning: modules table ID not available --></li>
                      {% endif %}
                    {% elif prereq is mapping %}
                      {# External resource with title and URL #}
                      {% if prereq.url %}
                        <li><a href="{{ prereq.url }}" rel="noopener" target="_blank">{{ prereq.title|default(prereq.url) }}</a></li>
                      {% else %}
                        {# Missing URL - render title as plain text #}
                        <li>{{ prereq.title|default('Untitled prerequisite') }}</li>
                      {% endif %}
                    {% else %}
                      {# Unexpected format - skip #}
                    {% endif %}
                  {% endfor %}
                </ul>
              </section>
            {% endif %}
          {% endif %}

          {#
            Prev/Next Navigation
            Resolution order:
            1. If module belongs to a pathway (via pathways table's module_slugs_json), use pathway ordering
            2. Otherwise, use fallback: all modules ordered by display_order, then hs_name

            Hardening notes:
            - Falls back to dynamic_page_hubdb_table_id when constants are missing
            - Guards against JSON parse errors in pathway module_slugs_json
            - Generates <link rel=prev/next> tags in head for SEO
          #}
          {% set prev_module = none %}
          {% set next_module = none %}
          {% set current_slug = dynamic_page_hubdb_row.hs_path %}

          {# Try to find pathway context first - with fallback when constants missing #}
          {#
            Issue #327 Fix: Inline constants instead of using request_json (which doesn't exist in HubL)
            HubL cannot fetch/parse JSON files server-side, so we inline the values directly.
            Source: clean-x-hedgehog-templates/config/constants.json
          #}
          
          {% set pathways_table_id = constants.HUBDB_PATHWAYS_TABLE_ID %}
          {% set modules_table_id = constants.HUBDB_MODULES_TABLE_ID or dynamic_page_hubdb_table_id %}
          {% set in_pathway = false %}

          {% if pathways_table_id %}
            {# Find pathways that contain this module #}
            {% set all_pathways = hubdb_table_rows(pathways_table_id, "tags__not__icontains=archived") %}
            {% for pathway in all_pathways %}
              {% if pathway.module_slugs_json and not in_pathway %}
                {% set module_slugs = pathway.module_slugs_json|fromjson %}

                {% if module_slugs and current_slug in module_slugs %}
                  {% set in_pathway = true %}
                  {# Find current module index in pathway #}
                  {% for slug in module_slugs %}
                    {% if slug == current_slug %}
                      {% set current_index = loop.index0 %}
                      {# Get previous module #}
                      {% if current_index > 0 %}
                        {% set prev_slug = module_slugs[current_index - 1] %}
                        {% set prev_rows = hubdb_table_rows(modules_table_id, "path__eq=" ~ prev_slug ~ "&tags__not__icontains=archived") %}
                        {% if prev_rows and prev_rows|length > 0 %}
                          {% set prev_module = prev_rows[0] %}
                        {% endif %}
                      {% endif %}
                      {# Get next module #}
                      {% if current_index < (module_slugs|length - 1) %}
                        {% set next_slug = module_slugs[current_index + 1] %}
                        {% set next_rows = hubdb_table_rows(modules_table_id, "path__eq=" ~ next_slug ~ "&tags__not__icontains=archived") %}
                        {% if next_rows and next_rows|length > 0 %}
                          {% set next_module = next_rows[0] %}
                        {% endif %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}

          {# Fallback: Use all modules ordered by display_order #}
          {% if not in_pathway and modules_table_id %}
            {% set all_modules = hubdb_table_rows(modules_table_id, "orderBy=display_order&tags__not__icontains=archived") %}
            {% for module in all_modules %}
              {% if module.hs_path == current_slug %}
                {% set current_index = loop.index0 %}
                {# Get previous module #}
                {% if current_index > 0 %}
                  {% set prev_module = all_modules[current_index - 1] %}
                {% endif %}
                {# Get next module #}
                {% if current_index < (all_modules|length - 1) %}
                  {% set next_module = all_modules[current_index + 1] %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}

          <!-- Prev/Next Navigation Bar -->
          {% if prev_module or next_module %}
          <nav class="module-nav" role="navigation" aria-label="Module navigation">
            <div class="module-nav-container">
              {% if prev_module %}
              <a href="/learn/modules/{{ prev_module.hs_path }}" class="module-nav-link module-nav-prev">
                <span class="module-nav-arrow" aria-hidden="true">←</span>
                <div class="module-nav-content">
                  <span class="module-nav-label">Previous</span>
                  <span class="module-nav-title">{{ prev_module.hs_name }}</span>
                </div>
              </a>
              {% else %}
              <div class="module-nav-spacer"></div>
              {% endif %}

              {% if next_module %}
              <a href="/learn/modules/{{ next_module.hs_path }}" class="module-nav-link module-nav-next">
                <div class="module-nav-content">
                  <span class="module-nav-label">Next</span>
                  <span class="module-nav-title">{{ next_module.hs_name }}</span>
                </div>
                <span class="module-nav-arrow" aria-hidden="true">→</span>
              </a>
              {% else %}
              <div class="module-nav-spacer"></div>
              {% endif %}
            </div>
          </nav>
          {% endif %}

          <!-- Module Content -->
          {% set is_archived = false %}
          {% if dynamic_page_hubdb_row.tags %}
            {% set tag_list = dynamic_page_hubdb_row.tags|lower|split(',') %}
            {% for tag in tag_list %}
              {% if tag|trim == 'archived' %}
                {% set is_archived = true %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% if is_archived %}
            <div style="background:#FEF3C7; border:1px solid #F59E0B; color:#92400E; padding:12px 16px; border-radius:8px; margin-bottom:16px;">
              This module is archived and may be out of date.
            </div>
          {% endif %}
          <div class="module-content">
            {# Prefer full_content when present #}
            {% if dynamic_page_hubdb_row.full_content %}
              {{ dynamic_page_hubdb_row.full_content|safe }}
            {% elif dynamic_page_hubdb_row.content_blocks_json %}
              {# Render simple content blocks fallback (text/callout) if provided #}
              {% set blocks = dynamic_page_hubdb_row.content_blocks_json|fromjson %}
              {% for block in blocks %}
                {% if block.type == 'text' %}
                  {% if block.title %}<h2>{{ block.title }}</h2>{% endif %}
                  {% if block.body_markdown %}{{ block.body_markdown|safe }}{% endif %}
                {% elif block.type == 'callout' %}
                  <div class="content-block content-block-callout">
                    {% if block.title %}<h2>{{ block.title }}</h2>{% endif %}
                    {% if block.body_markdown %}{{ block.body_markdown|safe }}{% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            {% elif dynamic_page_hubdb_row.summary_markdown %}
              {{ dynamic_page_hubdb_row.summary_markdown|safe }}
            {% else %}
              <p><em>Module content coming soon.</em></p>
            {% endif %}
          </div>
        </div>
      </div>
    </section>

  {% else %}
    {# List view - showing all modules #}
    <section class="learn-header-section">
      <div class="learn-header-content">
        <h1 class="learn-page-title">Learning Modules</h1>
        <p class="learn-page-subtitle">Browse all available learning modules to build your skills in AI networking</p>
      </div>
    </section>

    <div class="learn-layout-with-nav">
      {# Left navigation #}
      {{ learning_left_nav('modules', show_filters=false) }}

      {# Main content area #}
      <div class="learn-main-content">
        {% if dynamic_page_hubdb_table_id %}
          {% set modules = hubdb_table_rows(dynamic_page_hubdb_table_id, "orderBy=display_order&tags__not__icontains=archived") %}
          {% if modules %}
            <div class="modules-grid">
              {% for module in modules %}
                {% set is_archived = false %}
                {% if module.tags %}
                  {% set tag_list = module.tags|lower|split(',') %}
                  {% for tag in tag_list %}
                    {% if tag|trim == 'archived' %}
                      {% set is_archived = true %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {% if not is_archived %}
                <a href="/learn/modules/{{ module.hs_path }}" class="module-card">
                  <div class="module-card-header">
                    <span class="difficulty-badge">
                      {{ module.difficulty.label }}
                    </span>
                    <span class="module-time">
                      {{ module.estimated_minutes }} min
                    </span>
                  </div>

                  <h3>{{ module.hs_name }}</h3>

                  {% if module.meta_description %}
                    <p>{{ module.meta_description|striptags|truncate(150) }}</p>
                  {% endif %}

                  {% if module.tags %}
                    <div class="module-tags">
                      {% set tag_list = module.tags.split(',') %}
                      {% for tag in tag_list %}
                        {% if tag|lower|trim != 'archived' %}
                          <span class="module-tag">{{ tag|trim }}</span>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}

                  <span class="module-cta">View Module →</span>
                </a>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            <p>No learning modules have been added yet.</p>
          {% endif %}
        {% else %}
          <p><em>This is a preview. Content will populate once this template is used on a dynamic page connected to a HubDB table.</em></p>
        {% endif %}
      </div>
    </div>
    {# Cognito auth context for nav auth state on list pages #}
    {#
      Issue #327 Fix: Inline constants instead of using request_json (which doesn't exist in HubL)
      HubL cannot fetch/parse JSON files server-side, so we inline the values directly.
      Source: clean-x-hedgehog-templates/config/constants.json
    #}
    
    {% set auth_me_url = constants.AUTH_ME_URL if constants and constants.AUTH_ME_URL else 'https://api.hedgehog.cloud/auth/me' %}
    {% set login_url = constants.AUTH_LOGIN_URL if constants and constants.AUTH_LOGIN_URL else 'https://api.hedgehog.cloud/auth/login' %}
    {% set logout_url = constants.AUTH_LOGOUT_URL if constants and constants.AUTH_LOGOUT_URL else 'https://api.hedgehog.cloud/auth/logout' %}
    <div
      id="hhl-auth-context"
      data-auth-me-url="{{ auth_me_url }}"
      data-auth-login-url="{{ login_url }}"
      data-auth-logout-url="{{ logout_url }}"
      data-track-events-url="https://api.hedgehog.cloud/events/track"
      data-enable-crm="true"
      style="display:none"
    ></div>
    <script src="{{ get_asset_url('/CLEAN x HEDGEHOG/templates/learn/assets/js/cognito-auth-integration.js') }}"></script>
  {% endif %}
</main>
{% endblock body %}
